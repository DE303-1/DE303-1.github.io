<!DOCTYPE html>

<!-- Mirrored from flowingdata.com/projects/2016/timeuse-bydemo/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 29 Jul 2021 20:48:06 GMT -->
<head>
<title>American Time Use for Different Groups</title>
<link rel="stylesheet" href="style/style.css" type="text/css" media="screen" />
<link href='https://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
<meta charset="utf-8">
</head>
<body>
<div id="main-wrapper">


<div id="controls">
<div>
<div class="sentence">I am&nbsp;</div>
<div id="sex" class="dropdown-wrapper" , tabindex="1" style="float:left;z-index:10">
<span>Sex</span>
<ul class="dropdown"></ul>
</div>
<div id="age" class="dropdown-wrapper" , tabindex="2" style="float:left;z-index:9">
<span>Age</span>
<ul class="dropdown"></ul>
</div>

<div id="empstat" class="dropdown-wrapper" , tabindex="2" style="float:left;z-index:9">
<span>Employment</span>
<ul class="dropdown"></ul>
</div>

<div id="dayweek" class="dropdown-wrapper" , tabindex="2" style="float:left;z-index:5">
<span>Day of the Week</span>
<ul class="dropdown"></ul>
</div>
<div class="clr"></div>
</div>
</div>
<div id="chart"></div>
<div id="scaleoptions">
<div id="buttons">
<div class="clr"></div>
</div>
</div>
</div>
<script src="js/d3-3-5-5.min.js"></script>
<script>
var USER_SCALE = 'relative',
    USER_SEX = 'f',
    USER_AGE = '18',
    USER_EMPSTAT = 'e',
    USER_DAYWEEK = 'd';
var USER_GROUP = USER_SEX + USER_DAYWEEK + USER_EMPSTAT + USER_AGE;

// var activities = ["010101", "010000", "020000", "030000", "050000", "060000", "110000", "120000", "130000", "140000", "180000", "other"];
var activities = ["010101", "010000", "020000", "030000", "050000", "060000", "110000", "120000", "180000"];
var act_names = {
	"010101":"Sleeping",
	"010000":"Personal Care",
	"020000":"Household Work",
	"030000":"Caring for Others",
	"050000":"Work",
	"060000":"Education",
	"110000":"Eating",
	"120000":"Leisure",
	"180000":"Travel or Commute"
};

var sexes = {
	"f": "female",
	"m": "male",
};
var ages = {
    "18": "18 to 24",
    "25": "25 to 44",
    "45": "45 to 64",
    "65": "65 or more",
};
var empstats = {
    "e": "employed",
    "u": "unemployed",
    "n": "not looking"
}
var dayweeks = {
    "d": "weekday",
    "e": "weekend",
}

var margin = {top: 0, right: 10, bottom: 20, left: 110},
    width = 800 - margin.left - margin.right,
	height = 600 - margin.top - margin.bottom;

var x = {};
var y = d3.scale.ordinal()
	.domain(activities)
	.rangePoints([0, height], 1);

var line = d3.svg.line();
var axis = d3.svg.axis().orient("bottom").tickFormat(d3.format("d"));
var lineMedian = d3.svg.line()
    .x(function(d) { return x[d.act](d.val/60); })
    .y(function(d) { return y(d.act); });


var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

d3.tsv("data/sims_final.tsv", type, function(error, data) {

    var sims_by_grp = {};
	data.forEach(function(d) {

        if (!(d.key in sims_by_grp)) {
            sims_by_grp[d.key] = [];
        }

        sims_by_grp[d.key].push(d);
	});


    //
    // x-scale for each activity
    //
    activities.forEach(function(act) {
        x[act] = d3.scale.linear().range([0, width]);
        if (USER_SCALE == 'relative') {
		    x[act].domain([0, d3.max(sims_by_grp[USER_GROUP].map(function(sim) {
                    return sim['a_'+act] / 60;
                }))]
            )
        } else if (USER_SCALE == 'absolute') {
		    x[act].domain([0, 24]);
        }
    });


    //
    // Lines
    //
    var simlines = svg.append("g")
        .attr("class", "background")
      .selectAll("path")
        .data(sims_by_grp[USER_GROUP])
      .enter().append("path")
        .attr("class", "simline")
        .attr("d", path);


    //
    // Axes
    //
    var g = svg.selectAll(".dimension")
        .data(activities)
    .enter().append("g")
      .attr("class", "activity")
      .attr("transform", function(d) { return "translate(0," + y(d) + ")"; });

    g.append("g")
        .attr("class", "axis")
        .each(function(d) { d3.select(this).call(axis.scale(x[d])); })
      .append("text")
        .attr("class", "activitylab")
        .style("text-anchor", "start")
	  	.attr("dy", "1.0em")
        .attr("x", -margin.left+10)
        .attr("y", -10)
        .text(function(d) { return act_names[d]; });
	g.selectAll(".activitylab").call(wrap, margin.left-20);


    //
    // TODO: MEDIAN dots
    //
    var median_vals = activities.map(function(act) {
        var obj = {
            act: act,
            val: d3.median(sims_by_grp[USER_GROUP].map(function(sim) { return sim['a_'+act] })),
        };

        return obj;
    });


    var medianlab = svg.append("g")
        .attr("class", "medianlab")
        .attr("text-anchor", "middle")
        .attr("transform", "translate("+x[median_vals[0].act](median_vals[0].val/60)+","+y(median_vals[0].act)+")");
    medianlab.append("text")
        .attr("dy", "-1.2em")
        .text("Median");
    var median_line = svg.append("path")
        .datum(median_vals)
        .attr("class", "medianline")
        .attr("d", lineMedian);

    var simmedian = svg.append("g")
        .attr("class", "median")
      .selectAll("circle")
        .data(median_vals)
      .enter().append("circle")
        .attr("class", "mediancircle")
        .attr("cx", function(d) { return x[d.act](d.val/60); })
        .attr("cy", function(d) { return y(d.act); })
        .attr("r", 5);




    //
    // User controls
    //

    d3.selectAll("#buttons .button").on("click", function() {
        USER_SCALE = d3.select(this).attr("data-val");
    	d3.select("#buttons .current").classed("current", false);
    	d3.select(this).classed("current", true);
        update();
    });


    // TODO: There's a more efficicient way to make all these dropdown menus, but.

	// Sex dropdown menu
    var dropdown_sex = d3.select("#controls #sex");
	dropdown_sex.select("span").text(sexes[USER_SEX]);
    dropdown_sex.on("click", function() {
        d3.select(this).classed("active", !d3.select(this).classed("active"));
    });
    var dropdown_sex_li = dropdown_sex.select(".dropdown").selectAll("li")
        .data(Object.keys(sexes))
      .enter().append("li")
        .attr("id", function(d) { return d; })
        .classed("current", function(d) { return d == USER_SEX ? true : false; })
        .text(function(d) { return sexes[d]; });
    dropdown_sex_li.on("click", function(d) {
        d3.select("#sex span").text(sexes[d]);
        d3.select(this).classed("current", true); // Hide currently selected metric from menu
        d3.select("#sex #" + USER_SEX).classed("current", false);   // Show previously hidden

        USER_SEX = d;

        update();
    });


	// Age dropdown menu
    var dropdown_age = d3.select("#controls #age");
	dropdown_age.select("span").text(ages[USER_AGE]);
    dropdown_age.on("click", function() {
        d3.select(this).classed("active", !d3.select(this).classed("active"));
    });
    var dropdown_age_li = dropdown_age.select(".dropdown").selectAll("li")
        .data(Object.keys(ages))
      .enter().append("li")
        .attr("id", function(d) { return "a"+d; })
        .classed("current", function(d) { return d == USER_AGE ? true : false; })
        .text(function(d) { return ages[d]; });
    dropdown_age_li.on("click", function(d) {
        d3.select("#age span").text(ages[d]);
        d3.select(this).classed("current", true); // Hide currently selected metric from menu
        d3.select("#age #a" + USER_AGE).classed("current", false);   // Show previously hidden

        USER_AGE = d;
		USER_KEY = USER_SEX + USER_AGE;
        update();
    });


    // Employment status dropdown menu
    var dropdown_empstat = d3.select("#controls #empstat");
	dropdown_empstat.select("span").text(empstats[USER_EMPSTAT]);
    dropdown_empstat.on("click", function() {
        d3.select(this).classed("active", !d3.select(this).classed("active"));
    });
    var dropdown_empstat_li = dropdown_empstat.select(".dropdown").selectAll("li")
        .data(Object.keys(empstats))
      .enter().append("li")
        .attr("id", function(d) { return d; })
        .classed("current", function(d) { return d == USER_EMPSTAT ? true : false; })
        .text(function(d) { return empstats[d]; });
    dropdown_empstat_li.on("click", function(d) {
        d3.select("#empstat span").text(empstats[d]);
        d3.select(this).classed("current", true); // Hide currently selected metric from menu
        d3.select("#empstat #" + USER_EMPSTAT).classed("current", false);   // Show previously hidden

        USER_EMPSTAT = d;

        update();
    });


    // Weekday/end dropdown menu
    var dropdown_dayweek = d3.select("#controls #dayweek");
	dropdown_dayweek.select("span").text(dayweeks[USER_DAYWEEK]);
    dropdown_dayweek.on("click", function() {
        d3.select(this).classed("active", !d3.select(this).classed("active"));
    });
    var dropdown_dayweek_li = dropdown_dayweek.select(".dropdown").selectAll("li")
        .data(Object.keys(dayweeks))
      .enter().append("li")
        .attr("id", function(d) { return d; })
        .classed("current", function(d) { return d == USER_DAYWEEK ? true : false; })
        .text(function(d) { return dayweeks[d]; });
    dropdown_dayweek_li.on("click", function(d) {
        d3.select("#dayweek span").text(dayweeks[d]);
        d3.select(this).classed("current", true); // Hide currently selected metric from menu
        d3.select("#dayweek #" + USER_DAYWEEK).classed("current", false);   // Show previously hidden

        USER_DAYWEEK = d;

        update();
    });




    function update() {
        USER_GROUP = USER_SEX + USER_DAYWEEK + USER_EMPSTAT + USER_AGE;

		// Update axes
	    activities.forEach(function(act) {
	        if (USER_SCALE == 'relative') {
			    x[act].domain([0, d3.max(sims_by_grp[USER_GROUP].map(function(sim) {
	                	return sim['a_'+act] / 60;
	                }))]
	            )
	        } else if (USER_SCALE == 'absolute') {
			    x[act].domain([0, 24]);
	        }
	    });
    	svg.selectAll('.axis')
			.transition()
			.duration(000)
        	.each(function(d) { d3.select(this).call(axis.scale(x[d])); })


        // Update lines
        simlines.data(sims_by_grp[USER_GROUP]);

        svg.selectAll(".simline")
            .transition()
            .duration(000)
            .attr("d", path);


        // Update medians
        median_vals.map(function(d) {
            d.val = d3.median(sims_by_grp[USER_GROUP].map(function(sim) {
                return sim['a_'+d.act];
            }));

            return d;
        });
        median_line.datum(median_vals);
        median_line
            .transition()
            .duration(000)
            .attr("d", lineMedian);

        simmedian.data(median_vals);
        svg.selectAll(".mediancircle")
            .transition()
            .duration(600)
            .attr("cx", function(d) {
            return x[d.act](d.val/60);
        });
        medianlab
            .transition()
            .duration(000)
            .attr("transform", "translate("+x[median_vals[0].act](median_vals[0].val/60)+","+y(median_vals[0].act)+")");

    }


}); // @end load data


function path(d) {
    return line(activities.map(function(p) { return [x[p](d['a_'+p]/60), y(p)]; }));
}


function type(d, i) {
	d3.keys(d).map(function(key) {
        if (key != "key") {
            d[key] = +d[key];
        }
	});

	return d;
}


// For SVG text-wrapping
function wrap(text, width) {
  text.each(function() {
    var text = d3.select(this),
        words = text.text().split(/\s+/).reverse(),
        word,
        line = [],
        lineNumber = 0,
        lineHeight = 1.2, // ems
        y = text.attr("y"),
        dy = parseFloat(text.attr("dy")),
        tspan = text.text(null).append("tspan").attr("x", -margin.left+10).attr("y", y).attr("dy", dy + "em");
    while (word = words.pop()) {
      line.push(word);
      tspan.text(line.join(" "));
      if (tspan.node().getComputedTextLength() > width) {
        line.pop();
        tspan.text(line.join(" "));
        line = [word];
		tspan = text.append("tspan").attr("x", -margin.left+10).attr("y", y).attr("dy", lineHeight + dy + "em").text(word);
        // tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
      }
    }
  });
}
</script>
